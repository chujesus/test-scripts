
IF db_id('[SCDBNAME]') IS NULL 
BEGIN
	CREATE DATABASE [SCDBNAME]
END
GO
IF (1 = FULLTEXTSERVICEPROPERTY('IsFullTextInstalled'))
begin
EXEC [SCDBNAME].[dbo].[sp_fulltext_database] @action = 'enable'
end
GO
USE [SCDBNAME]
GO
IF NOT EXISTS (SELECT name FROM sys.filegroups WHERE is_default=1 AND name = N'PRIMARY') ALTER DATABASE [SCDBNAME] MODIFY FILEGROUP [PRIMARY] DEFAULT
GO

ALTER DATABASE [SCDBNAME]  SET AUTO_SHRINK ON;
GO
ALTER DATABASE [SCDBNAME] SET AUTO_CLOSE OFF WITH NO_WAIT
GO

sp_configure 'show advanced options', 1;
GO
RECONFIGURE;
GO
sp_configure 'clr enabled', 1;
GO
RECONFIGURE;
GO

/*DROP FUNCTIONS*/
IF EXISTS (SELECT * FROM sysobjects WHERE type = 'FS' AND id = OBJECT_ID(N'SC_DecompressXML'))
    BEGIN
            DROP  FUNCTION  [SC_DecompressXML]
    END

GO
IF EXISTS (SELECT * FROM sysobjects WHERE type = 'FS' AND id = OBJECT_ID(N'[dbo].CMM_GetASCIIValueSumFnc'))
    BEGIN
            DROP  FUNCTION  [CMM_GetASCIIValueSumFnc]
    END

GO
IF EXISTS (SELECT * FROM sysobjects WHERE type = 'FS' AND id = OBJECT_ID(N'[dbo].CMM_RemoveSpecialCharsFnc'))
    BEGIN
            DROP  FUNCTION  [CMM_RemoveSpecialCharsFnc]
    END

GO 
IF EXISTS (SELECT * FROM sysobjects WHERE type = 'FS' AND id = OBJECT_ID(N'[CMM_NormalizeNameFnc]'))
    BEGIN
            DROP  FUNCTION  [CMM_NormalizeNameFnc]
    END

GO 

/*REGISTER ASSEMBLY*/
IF EXISTS (SELECT * FROM  sys.assembly_files WHERE name = 'Premier.SqlCLRUtils')
    BEGIN
            DROP  ASSEMBLY  [Premier.SqlCLRUtils]
    END
GO

/* Validate SQL Version and execute only for 2017 or higher */
IF((SELECT SERVERPROPERTY('ProductVersion')) >= '14')
BEGIN
	USE [MASTER]

	IF EXISTS (SELECT 1 FROM SYSLOGINS WHERE name = 'ClrLogin')
	BEGIN
		DROP LOGIN [CLRLogin];
	END

	IF EXISTS (SELECT 1 FROM SYS.CERTIFICATES where name = 'ClrCert')
	BEGIN
		DROP CERTIFICATE [CLRCert];
	END

	/* MSSQL in 2008 Version does not support FROM BINARY */
	EXEC('CREATE CERTIFICATE [ClrCert] FROM BINARY = 0x30820302308201EEA0030201020210D7B69322BD8AFE8E49F52E3685822B6C300906052B0E03021D05003019311730150603550403130E7072656D6965727761792E636F6D301E170D3138313130363136343132385A170D3330313233313036303030305A3019311730150603550403130E7072656D6965727761792E636F6D30820122300D06092A864886F70D01010105000382010F003082010A0282010100AED2995766632E2E66941D8BF356B575BCB981E0D1D6911838C935AA44653805C8F8F092DF43249EBD2982EB24693F85DD7A40E2B85994A2F90249C0869A49C3866A279CA683964C3FE9EC7AE235210A5B6FB7F1E3BA0D689B30F0408BC618646D9AA5A2F9C1D5368C30B70015B33F1D27731A79FD01F1AEEDB6E3C886BBF6955C7D7CA9F08BFE0E803F9F71CC65BEB198DEEEE95FE14170C9D16A229B35981AC46AD1D8A37819EE97D2DD9C8BEAAC9379AC2F5C5F894FDED2F6F5DD57BE306F40034699A52E6F41ACE91F400E685F74B04D8944EFF8313C91E81F4020B45EC0E91DBA7C6CD4131367D255164A5494B714522F73492834E0E42B576BD9F33CB90203010001A34E304C304A0603551D0104433041801044C881050A63774251F4B62AE26DCC2AA11B3019311730150603550403130E7072656D6965727761792E636F6D8210D7B69322BD8AFE8E49F52E3685822B6C300906052B0E03021D05000382010100AA81C5CFEFBFB5C55F43234D9A401DD108CB8974377BE9075F0545598F13221C9963F31322B0A9F622C57FD627A5D7A295EA57E20B0688EE17CB4825C70D8696FCA42543FA7B33B524E8B878D1CFC8429E46ADA3D3C96B828B88697C67D37B32EB7E15E083D84ED16A4A75791005A01757873129A99F7C0219AC7F19422FD5C9E4E0DD4ABBC6718C0CEDBC3E5F9879125A5814BAB75628B9AF58A5E4C6B1A7C2490BD46868E9CD103ED75FAAF1EA85845DC1BD72690FA7D732035CBA1C0C8481C7AC0BEDCB97A2ADE4E0249B744B57CC63A818352825812DA5A7C3FE68487B56D5B74D3B368EEBC5787A644DF8C30519105362E99026393FA89EE751DCD1996C');
	
	CREATE LOGIN [ClrLogin] FROM CERTIFICATE [ClrCert];
	
	GRANT UNSAFE ASSEMBLY TO [ClrLogin];
	
	USE [SCDBNAME]
	
END
GO

CREATE ASSEMBLY [Premier.SqlCLRUtils]
                  FROM
				  0x4D5A90000300000004000000FFFF0000B800000000000000400000000000000000000000000000000000000000000000000000000000000000000000800000000E1FBA0E00B409CD21B8014CCD21546869732070726F6772616D2063616E6E6F742062652072756E20696E20444F53206D6F64652E0D0D0A2400000000000000504500004C01030053F19A600000000000000000E00022200B013000001200000008000000000000D6310000002000000040000000000010002000000002000004000000000000000400000000000000008000000002000048700000030040850000100000100000000010000010000000000000100000000000000000000000843100004F000000004000006C0400000000000000000000001C000038050000006000000C00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000200000080000000000000000000000082000004800000000000000000000002E74657874000000DC110000002000000012000000020000000000000000000000000000200000602E727372630000006C040000004000000006000000140000000000000000000000000000400000402E72656C6F6300000C0000000060000000020000001A00000000000000000000000000004000004200000000000000000000000000000000B8310000000000004800000002000500B4230000D00D000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001B3002003500000001000011140A04172E0604182E0C2B120317731100000A0A2B080317731200000A0A02062803000006DE0D7A062C08066F1300000A140ADC2A000000011C0000000002002527000114000001020002002628000C000000001B3002003500000001000011140A04172E0604182E0C2B120216731100000A0A2B080216731200000A0A06032803000006DE0D7A062C08066F1300000A140ADC2A000000011C0000000002002527000114000001020002002628000C0000000013300400280000000200001120011000008D1E0000010A160B020616068E696F1400000A0B072D012A030616076F1500000A2BE51E02281600000A2A5A026F1700000A72010000707231000070281800000A2A9603281900000A2D03032B0572350000701001027239000070031E281A00000A6F1700000A2A0000001330040053000000030000111200FE1516000001026F1B00000A6F1700000A72570000707269000070281800000A6F1C00000A0B160C2B1A060708931F30590817585A281D00000A281E00000A0A0817580C08078E6932E006281F00000A2A001B3003003800000004000011732000000A0A026F2100000A732200000A06032801000006066F2300000A066F2400000A732500000A0BDE0A062C06066F2600000ADC072A0110000002000600262C000A00000000133003002800000005000011282700000A026F2800000A0A282700000A282900000A06282A00000A732500000A0328080000062A1B3003003800000004000011732000000A0A026F2100000A732200000A06032802000006066F2300000A066F2400000A732500000A0BDE0A062C06066F2600000ADC072A0110000002000600262C000A000000001B3004005C00000006000011732000000A0A026F2100000A732200000A06032802000006066F2300000A06166A6F2B00000A066F2400000A0B282900000A0716078E696F2C00000A0C282900000A086F2D00000A732500000A0DDE0A062C06066F2600000ADC092A01100000020006004A50000A000000001B3003004C00000007000011732000000A0A026F2100000A732200000A06032802000006066F2300000A06166A6F2B00000A06282E00000A0B07732F00000A0CDE14072C06076F2600000ADC062C06066F2600000ADC082A011C000002002D000936000A00000000020006003A40000A0000000042534A4201000100000000000C00000076322E302E35303732370000000005006C000000D4040000237E000040050000B405000023537472696E677300000000F40A00006C00000023555300600B0000100000002347554944000000700B00006002000023426C6F620000000000000002000001571D02000900000000FA013300160000010000002400000004000000040000000C000000170000002F00000003000000160000000700000001000000040000000000050301000000000006003102360406009E0236040600430104040F006704000006006B0187030600140287030600E001870306008502870306005102870306006A02870306008201870306005701170406001301170406009D0187030600BA01870306002101560406006C036003060036056003060059034C000600B20360030A00FF01DB030600FD0260030A00AD047604060053034C000A00280376040E00C1031D0312002F0371031200BA00710312003D0371030600BC0260030600DC02600312008905E30412000C05E3040600F80260030600D60060030600CB026A05000000002B000000000001000100010100008500CF0445000100010000001000CB03CF04490004000100810110000205CF0449000500050006065600F20056800501F5005680BC03F50051803400F90050200000000096002205FC000100B0200000000096002B05FC00040010210000000091004803060107004421000000008618FE03060009004C2100000000960076050E0109006321000000009600E2000E010B008C21000000009600E30214010D00EC21000000009600B8041A010E0040220000000096001E00220110007422000000009600B6041A011200C8220000000096000A001A01140040230000000096003E0029011600000001005D05000002006305000003008600000001005D05000002006305000003008600000001005D0500000200630500000100840500000200490500000100840500000200490500000100B300000001008B0400000200950000000100780000000200A400000001009D04000002009500000001009D04000002009500000001009D040000020095000900FE0301001100FE0306001900FE030A002900FE0310003100FE0310003900FE0310004100FE0310004900FE0310005100FE0310005900FE0310006100FE0315006900FE0310007100FE0310007900FE0310008100FE031000A900FE030600D900FE031F00E900FE031F009900F0000600990073002D0099000D0135009100FE030600F900F6033D000101AB004100F900A30548000101AB004D00F90067033D00F90097055F00B1003D056400B10099036A001101D4027300C100FE030600B900C1028100C100FE0386009900F2020600C1008F058100B900FE0386001901F60006002101CA0091002101C6049700210101009100210155059D009900A503B50021011905BA002101C604C300D100FE00D300C900FE03DA0005000800E90005000C00EB0008001000ED002E000B0031012E0013003A012E001B0059012E00230062012E002B007B012E0033007B012E003B0081012E00430094012E004B00A9012E005300CE012E005B007B012E00630003022E006B002D022E0073003D022E007B005302A00083005B02C00083005B02E00083005B02000183005B02400183005B02600183005B02800183005B021A00270057007A008C00AA00CA00048000000700000000000000000000000000CF040000020000000000000000000000E0006A0000000000020000000000000000000000E0005E0000000000020000000000000000000000E0001D0300000000020000000000000000000000E00060030000000000000000006765745F55544638004465436F6D707265737342797465735554463800436F6D707265737355544638003C4D6F64756C653E004348554E4B53495A45004465436F6D7072657373584D4C0053797374656D2E494F0076616C75655F5F0053797374656D2E44617461006D73636F726C6962005265616400756E436F6D707265737365640065436F6D70726573734D6574686F6400636F6D70726573734D6574686F64006D6574686F64005265706C61636500736F7572636500436F6D7072657373696F6E4D6F6465006765745F556E69636F64650049446973706F7361626C65004E6F726D616C697A654E616D6500436C6F736500446973706F736500437265617465004465666C6174650057726974650047756964417474726962757465004E65757472616C5265736F75726365734C616E67756167654174747269627574650044656275676761626C6541747472696275746500436F6D56697369626C6541747472696275746500417373656D626C795469746C6541747472696275746500417373656D626C7954726164656D61726B41747472696275746500417373656D626C7946696C6556657273696F6E41747472696275746500417373656D626C79496E666F726D6174696F6E616C56657273696F6E41747472696275746500417373656D626C79436F6E66696775726174696F6E4174747269627574650053716C46756E6374696F6E41747472696275746500417373656D626C794465736372697074696F6E41747472696275746500436F6D70696C6174696F6E52656C61786174696F6E7341747472696275746500417373656D626C7950726F6475637441747472696275746500417373656D626C79436F7079726967687441747472696275746500417373656D626C79436F6D70616E794174747269627574650052756E74696D65436F6D7061746962696C6974794174747269627574650042797465006765745F56616C756500456E636F64696E67004365696C696E6700537472696E67004765744E756D657269634861736800466C757368004D61746800446563696D616C005072656D6965722E53716C434C525574696C732E646C6C0053797374656D2E586D6C0053716C586D6C004465666C61746553747265616D00475A697053747265616D00436F707953747265616D004D656D6F727953747265616D0053797374656D005472696D00456E756D0053797374656D2E494F2E436F6D7072657373696F6E0053797374656D2E5265666C656374696F6E006F705F4164646974696F6E007365745F506F736974696F6E00457863657074696F6E00477A697000586D6C52656164657200436F6D707265737357726170706572004D6963726F736F66742E53716C5365727665722E53657276657200546F4C6F776572002E63746F720053797374656D2E446961676E6F73746963730053797374656D2E52756E74696D652E496E7465726F7053657276696365730053797374656D2E52756E74696D652E436F6D70696C657253657276696365730053797374656D2E5265736F757263657300446562756767696E674D6F6465730053797374656D2E446174612E53716C547970657300756E436F6D70726573736564427974657300636F6D7072657373656442797465730053716C4279746573004465436F6D70726573734279746573004765744279746573005072656D6965722E53716C434C525574696C730053797374656D2E546578742E526567756C617245787072657373696F6E730046756E6374696F6E730052656765784F7074696F6E7300476574436861727300436F6D7072657373004465636F6D7072657373004F626A656374006F705F496D706C69636974007265706C6163656D656E7400436F6E7665727400696E707574006F75747075740053797374656D2E54657874004E6F726D616C697A6554657874007465787400526567657800546F417272617900546F4368617241727261790049734E756C6C4F72456D70747900000000002F5B005E005C0070007B004C007D005C002D005C0021005C0024005C0028005C0029005C0040005C0064005F005D0001032D0001035F00001D5B005E0061002D007A0041002D005A0030002D0039005F005D002B00011128005B005E005C0077005D002B00290000010000A4CBD240E6E8ED40BEDD9853DCEF243100042001010803200001052001011111042001010E0420010102040701124D07200201124D11710507021D0508072003081D050808072003011D0508080320000E0600030E0E0E0E040001020E0900040E0E0E0E11808507070311591D03080420001D03050001115908080002115911591159060001115911590607021261125D0420001D05052001011D050407011D050500001280910520011D050E0C00031D051280911280911D050A070412611D051D03125D042001010A0820031D031D0508080620011D051D030807031261126912650600011269124D05200101126908B77A5C561934E0890101010204001000000206050306110802060809000301124D124D110807000201124D124D0500020E0E0E05000111590E070002125D125D05060002125D0E050700021265125D050801000800000000001E01000100540216577261704E6F6E457863657074696F6E5468726F777301080100020000000000180100135072656D6965722E53716C434C525574696C7300000501000000001201000D5052454D4945522047524F555000001401000F536D6172746572436F6D6D6572636500002401001F436F7079726967687420C2A9205052454D4945522047524F5550203230323100003401002F536D6172746572436F6D6D6572636520697320612074726164656D61726B206F66205052454D4945522047524F555000002901002438346330636138662D633732612D343233662D623262642D36643865346632333538343700000F01000A372E302E302E30303030000015010010372E302E302E32313035313131353034000007010002656E00000401000000AC3100000000000000000000C6310000002000000000000000000000000000000000000000000000B8310000000000000000000000005F436F72446C6C4D61696E006D73636F7265652E646C6C0000000000FF250020001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100100000001800008000000000000000000000000000000100010000003000008000000000000000000000000000000100000000004800000058400000100400000000000000000000100434000000560053005F00560045005200530049004F004E005F0049004E0046004F0000000000BD04EFFE00000100000007000000000000000700D07300003F000000000000000400000002000000000000000000000000000000440000000100560061007200460069006C00650049006E0066006F00000000002400040000005400720061006E0073006C006100740069006F006E00000000000000B00470030000010053007400720069006E006700460069006C00650049006E0066006F0000004C03000001003000300030003000300034006200300000001A000100010043006F006D006D0065006E00740073000000000000003C000E00010043006F006D00700061006E0079004E0061006D006500000000005000520045004D004900450052002000470052004F00550050000000500014000100460069006C0065004400650073006300720069007000740069006F006E00000000005000720065006D006900650072002E00530071006C0043004C0052005500740069006C007300000036000B000100460069006C006500560065007200730069006F006E000000000037002E0030002E0030002E0030003000300030000000000050001800010049006E007400650072006E0061006C004E0061006D00650000005000720065006D006900650072002E00530071006C0043004C0052005500740069006C0073002E0064006C006C00000062001F0001004C006500670061006C0043006F007000790072006900670068007400000043006F0070007900720069006700680074002000A90020005000520045004D004900450052002000470052004F005500500020003200300032003100000000008800300001004C006500670061006C00540072006100640065006D00610072006B0073000000000053006D006100720074006500720043006F006D006D006500720063006500200069007300200061002000740072006100640065006D00610072006B0020006F00660020005000520045004D004900450052002000470052004F005500500000005800180001004F0072006900670069006E0061006C00460069006C0065006E0061006D00650000005000720065006D006900650072002E00530071006C0043004C0052005500740069006C0073002E0064006C006C000000400010000100500072006F0064007500630074004E0061006D0065000000000053006D006100720074006500720043006F006D006D0065007200630065000000460011000100500072006F006400750063007400560065007200730069006F006E00000037002E0030002E0030002E0032003100300035003100310031003500300034000000000038000800010041007300730065006D0062006C0079002000560065007200730069006F006E00000037002E0030002E0030002E0030000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003000000C000000D8310000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000038050000000202003082052706092A864886F70D010702A082051830820514020101310B300906052B0E03021A0500304C060A2B060104018237020104A03E303C3017060A2B06010401823702010F3009030100A004A20280003021300906052B0E03021A050004146D0BECFDB12D686FF7AB13AC0C1CA34047EA63FEA082030630820302308201EEA0030201020210D7B69322BD8AFE8E49F52E3685822B6C300906052B0E03021D05003019311730150603550403130E7072656D6965727761792E636F6D301E170D3138313130363136343132385A170D3330313233313036303030305A3019311730150603550403130E7072656D6965727761792E636F6D30820122300D06092A864886F70D01010105000382010F003082010A0282010100AED2995766632E2E66941D8BF356B575BCB981E0D1D6911838C935AA44653805C8F8F092DF43249EBD2982EB24693F85DD7A40E2B85994A2F90249C0869A49C3866A279CA683964C3FE9EC7AE235210A5B6FB7F1E3BA0D689B30F0408BC618646D9AA5A2F9C1D5368C30B70015B33F1D27731A79FD01F1AEEDB6E3C886BBF6955C7D7CA9F08BFE0E803F9F71CC65BEB198DEEEE95FE14170C9D16A229B35981AC46AD1D8A37819EE97D2DD9C8BEAAC9379AC2F5C5F894FDED2F6F5DD57BE306F40034699A52E6F41ACE91F400E685F74B04D8944EFF8313C91E81F4020B45EC0E91DBA7C6CD4131367D255164A5494B714522F73492834E0E42B576BD9F33CB90203010001A34E304C304A0603551D0104433041801044C881050A63774251F4B62AE26DCC2AA11B3019311730150603550403130E7072656D6965727761792E636F6D8210D7B69322BD8AFE8E49F52E3685822B6C300906052B0E03021D05000382010100AA81C5CFEFBFB5C55F43234D9A401DD108CB8974377BE9075F0545598F13221C9963F31322B0A9F622C57FD627A5D7A295EA57E20B0688EE17CB4825C70D8696FCA42543FA7B33B524E8B878D1CFC8429E46ADA3D3C96B828B88697C67D37B32EB7E15E083D84ED16A4A75791005A01757873129A99F7C0219AC7F19422FD5C9E4E0DD4ABBC6718C0CEDBC3E5F9879125A5814BAB75628B9AF58A5E4C6B1A7C2490BD46868E9CD103ED75FAAF1EA85845DC1BD72690FA7D732035CBA1C0C8481C7AC0BEDCB97A2ADE4E0249B744B57CC63A818352825812DA5A7C3FE68487B56D5B74D3B368EEBC5787A644DF8C30519105362E99026393FA89EE751DCD1996C318201A8308201A4020101302D3019311730150603550403130E7072656D6965727761792E636F6D0210D7B69322BD8AFE8E49F52E3685822B6C300906052B0E03021A0500A0523010060A2B06010401823702010C31023000301906092A864886F70D010903310C060A2B060104018237020104302306092A864886F70D010904311604144E78666B4D0ED9677F412A75342A659BA0A2B3A2300D06092A864886F70D0101010500048201006DD57A815D6E150D17BE92EDA6C0058B8B33E163981E5ED12C7A08C26538C2947B69C8BDA1FDDDCB15C8BA6350C69A0E9D8DC8696E9B1D15ACAC54A8F2B5743761F7F9605C5257E986E5F4DE8C5A6C38BCC15F74DD3B88F462031DE0B033C040A018F243B2FFD474B7FC36A8D6E14B0F9CD7E2F69CA67A586C0445A6A202E294871A0EAFEE7D4EE8932BB37F687F62863671608C55804AC61685A8524853D77DD4038A33D6B0D478F4B2241976A8B0A096742E612CBA8ABD78B110870F8F5197476630183467ECB014F625DABA2DCA32D319578709EE4490B6231CC8C858E7F1F1FB05208673C339B6A6EA3FCE8C90BAB91335FB2EAB5A5E0E314057935E4C070000000000
                  WITH PERMISSION_SET = SAFE
GO

/*CREATE FUNCTIONS*/
CREATE FUNCTION [SC_DecompressXML](
@compressedBlob varbinary(MAX),
@compressMode binary
)
RETURNS XML
AS    EXTERNAL NAME [Premier.SqlCLRUtils].[Premier.SqlCLRUtils.Functions].[DeCompressXML];
GO
                           
CREATE FUNCTION [CMM_RemoveSpecialCharsFnc](
@description NVARCHAR(MAX),
@replacement NVARCHAR(1)
)
RETURNS NVARCHAR(MAX)
AS    EXTERNAL NAME [Premier.SqlCLRUtils].[Premier.SqlCLRUtils.Functions].[NormalizeText];
GO
                           
CREATE FUNCTION [CMM_NormalizeNameFnc](
@description NVARCHAR(MAX),
@replacement NVARCHAR(1)
)
RETURNS NVARCHAR(MAX)
AS    EXTERNAL NAME [Premier.SqlCLRUtils].[Premier.SqlCLRUtils.Functions].[NormalizeName];
GO

CREATE FUNCTION [CMM_GetASCIIValueSumFnc](
@source NVARCHAR(MAX)
)
RETURNS DECIMAL
AS    EXTERNAL NAME [Premier.SqlCLRUtils].[Premier.SqlCLRUtils.Functions].[GetNumericHash];
GO

USE [SCDBNAME]
GO

CREATE TABLE [dbo].SALESORDERFILE(
	RecordUniqueID bigint NOT NULL,
	InstallationId NVARCHAR(3) NOT NULL,
	RegisterId NVARCHAR(30) NULL,
	DocumentType NVARCHAR(2) NOT NULL,
	DocumentID NVARCHAR(128) NOT NULL,
	DocumentBody varbinary(max) NULL,
	Status NVARCHAR(2) NOT NULL,
	UserInsert NVARCHAR(30) NOT NULL,
	DateInsert DECIMAL(18, 0) NOT NULL,
	TimeInsert DECIMAL(18, 0) NOT NULL,
	UserUpdate NVARCHAR(30) NULL,
	LastDateUpdated DECIMAL(18, 0) NULL,
	LastTimeUpdated DECIMAL(18, 0) NULL,
	CONSTRAINT PK_SALESORDERFILE_UniqueId PRIMARY KEY CLUSTERED (RecordUniqueID ASC)
) 
GO

CREATE TABLE [dbo].EMAILTEMPLATE(
	InstallationId NVARCHAR(3) NOT NULL,
	TemplateType NVARCHAR(10) NOT NULL,
	TemplateName NVARCHAR(100) NULL,
	ConfigBody NVARCHAR(max) NULL,
	HTMLBody NVARCHAR(max) NULL,
	DateInsert DECIMAL(18, 0) NOT NULL,
	TimeInsert DECIMAL(18, 0) NOT NULL,
	UserInsert NVARCHAR(30) NULL,
	UserUpdate NVARCHAR(30) NULL,
	LastDateUpdated DECIMAL(18, 0) NULL,
	LastTimeUpdated DECIMAL(18, 0) NULL,
	CONSTRAINT PK_EMAILTEMPLATE_InstallationId_TemplateType PRIMARY KEY CLUSTERED (InstallationId ASC, TemplateType ASC)
) 
GO

CREATE TABLE [dbo].EMAILTEMPLATELANGS(
	InstallationId NVARCHAR(3) NOT NULL,
	TemplateType NVARCHAR(10) NOT NULL,
	LanguagePref NVARCHAR(2) NOT NULL,
	ConfigBody NVARCHAR(max) NULL,
	HTMLBody NVARCHAR(max) NULL,
	DateInsert DECIMAL(18, 0) NOT NULL,
	TimeInsert DECIMAL(18, 0) NOT NULL,
	UserInsert NVARCHAR(30) NULL,
	UserUpdate NVARCHAR(30) NULL,
	LastDateUpdated DECIMAL(18, 0) NULL,
	LastTimeUpdated DECIMAL(18, 0) NULL,
	CONSTRAINT PK_EMAILTEMPLATELANGS_InstallationId_TemplateType PRIMARY KEY CLUSTERED ( InstallationId ASC, TemplateType ASC, LanguagePref ASC )
) 
GO

/*---------------- BEGIN: PIVOT TABLE TO GENERATE CATALOG ----------------*/
CREATE TABLE [dbo].SC_Catalog_NSM_TEMP
(
	JobGenerationKey	DECIMAL,
	InstallationID		NVARCHAR(3),
	CatalogID			NVARCHAR(3),
	NodeID				DECIMAL,
	ReferenceID			NVARCHAR(10),
	Description			NVARCHAR(30),
	LeftPosition		INT,
	RightPosition		INT,
	MediaFileUniqueID	INT,
	ApplyEffectiveDates	DECIMAL,
	EffectiveFrom		DECIMAL,
	EffectiveThru		DECIMAL,
	RelatedItemsMethod  NVARCHAR(2),
	UserID				NVARCHAR(10),
	WorkStationID		NVARCHAR(128), 
	DateUpdated			DECIMAL,
	TimeUpdated			DECIMAL,
	URLPath				VARCHAR(MAX),
	PathCode			DECIMAL,
	CONSTRAINT SCCatalogNSMTemp_PK PRIMARY KEY NONCLUSTERED (JobGenerationKey,InstallationID, CatalogID, NodeID)
)
GO
CREATE TABLE [dbo].SC_ItemMaster_TEMP
(
	JobGenerationKey	DECIMAL,
	UniqueID				INT IDENTITY(1,1)  NOT NULL,
	InstallationID			NVARCHAR(3),
	ShortItemNumber			DECIMAL,
	DisplayItemNumber		NVARCHAR(25),
	Description1			NVARCHAR(30),
	Description2			NVARCHAR(30),
	Description3			NVARCHAR(30),
	Content					NVARCHAR(MAX),
	BranchPlant				NVARCHAR(MAX),
	StockingType			NVARCHAR(2),
	InventoryFlag			NVARCHAR(1),
	ListPrice				DECIMAL,
	ForeignListPrice		DECIMAL,
	CurrencyMode			NVARCHAR(1),
	CurrencyCode			NVARCHAR(3),
	ForeignCurrencyCode	    NVARCHAR(3),
	DefaultUnitOfMeasure	NVARCHAR(3),
	PrimaryUnitOfMeasure	NVARCHAR(3),--IMUOM1
	PricingUnitOfMeasure	NVARCHAR(3),--IMUOM4
	ShippingUnitOfMeasure	NVARCHAR(3),--IMUOM6
	SCType					NVARCHAR(2),
	Template				NVARCHAR(20),
	ContentStatus			NVARCHAR(2),	
	UserID					NVARCHAR(10),
	WorkStationID			NVARCHAR(128), 
	DateUpdated				DECIMAL,
	TimeUpdated				DECIMAL,
	CONSTRAINT SCItemMasterTemp_PK PRIMARY KEY NONCLUSTERED (JobGenerationKey,InstallationID, ShortItemNumber)
)
GO
CREATE TABLE [dbo].SC_CatalogNodeItems_TEMP
(
	JobGenerationKey	DECIMAL,
	InstallationID	NVARCHAR(3),
	CatalogID		NVARCHAR(3),
	NodeID			DECIMAL,
	ShortItemNumber DECIMAL,
	Priority		INT,
	CONSTRAINT SCCatalogNodeItemsTemp_PK PRIMARY KEY NONCLUSTERED (JobGenerationKey,InstallationID, CatalogID, NodeID, ShortItemNumber)
)
GO

CREATE TABLE [dbo].SC_CatalogLangs_TEMP
(
	JobGenerationKey DECIMAL,
	InstallationID	NVARCHAR(3),
	CatalogID		NVARCHAR(3),
	NodeID			DECIMAL,
	LanguageID		NVARCHAR(2),
	Description		NVARCHAR(30),
	CONSTRAINT SCCatalogLangsTemp_PK PRIMARY KEY NONCLUSTERED (JobGenerationKey,InstallationID, CatalogID, NodeID, LanguageID)
)
GO
CREATE TABLE [dbo].SC_ItemMasterLangs_TEMP
(
	JobGenerationKey DECIMAL,
	UniqueID		INT IDENTITY(1,1)  NOT NULL,
	InstallationID	NVARCHAR(3),
	ShortItemNumber	DECIMAL,
	LanguageID		NVARCHAR(2),
	Description1	NVARCHAR(30),
	Description2	NVARCHAR(30),
	Description3	NVARCHAR(30),
	Content			NVARCHAR(MAX),
	CONSTRAINT SCItemMasterLangsTemp_PK PRIMARY KEY NONCLUSTERED (JobGenerationKey,InstallationID, ShortItemNumber, LanguageID)
)
GO

CREATE TABLE [dbo].SC_Catalog_NSM
(
	InstallationID		NVARCHAR(3),
	CatalogID			NVARCHAR(3),
	NodeID				DECIMAL,
	ReferenceID			NVARCHAR(10),
	Description			NVARCHAR(30),
	LeftPosition		INT,
	RightPosition		INT,
	MediaFileUniqueID	INT,
	ApplyEffectiveDates	DECIMAL,
	EffectiveFrom		DECIMAL,
	EffectiveThru		DECIMAL,
	UserID				NVARCHAR(10),
	WorkStationID		NVARCHAR(128), 
	DateUpdated			DECIMAL,
	TimeUpdated			DECIMAL,
	URLPath				VARCHAR(MAX),
	PathCode			DECIMAL,
	CONSTRAINT SCCatalogNSM_PK PRIMARY KEY (InstallationID, CatalogID, NodeID)
)
GO
CREATE INDEX SCCatalogNSM_Sec ON SC_Catalog_NSM (InstallationID, CatalogID, NodeID, PathCode)
GO
CREATE TABLE [dbo].SC_ItemMaster
(
	UniqueID				INT IDENTITY(1,1)  NOT NULL,
	InstallationID			NVARCHAR(3),
	ShortItemNumber			DECIMAL,
	DisplayItemNumber		NVARCHAR(25),
	Description1			NVARCHAR(30),
	Description2			NVARCHAR(30),
	Description3			NVARCHAR(30),
	Content					NVARCHAR(MAX),
	BranchPlant				NVARCHAR(MAX),
	StockingType			NVARCHAR(2),
	InventoryFlag			NVARCHAR(1),
	ListPrice				DECIMAL,
	ForeignListPrice		DECIMAL,
	CurrencyMode			NVARCHAR(1),
	CurrencyCode			NVARCHAR(3),
	ForeignCurrencyCode		NVARCHAR(3),
	DefaultUnitOfMeasure	NVARCHAR(3),
	PrimaryUnitOfMeasure	NVARCHAR(3),--IMUOM1
	PricingUnitOfMeasure	NVARCHAR(3),--IMUOM4
	ShippingUnitOfMeasure	NVARCHAR(3),--IMUOM6
	SCType					NVARCHAR(2),
	Template				NVARCHAR(20),
	ContentStatus			NVARCHAR(2),	
	UserID					NVARCHAR(10),
	WorkStationID			NVARCHAR(128), 
	DateUpdated				DECIMAL,
	TimeUpdated				DECIMAL,
	CONSTRAINT SCItemMaster_PK PRIMARY KEY(InstallationID, ShortItemNumber)
)
GO
CREATE UNIQUE INDEX SCItemMaster_UniqueID ON [dbo].SC_ItemMaster (UniqueID)
GO
CREATE TABLE [dbo].SC_CatalogNodeItems
(
	InstallationID	NVARCHAR(3),
	CatalogID		NVARCHAR(3),
	NodeID			DECIMAL,
	ShortItemNumber DECIMAL,
	Priority		INT,
	CONSTRAINT SCCatalogNodeItems_PK PRIMARY KEY (InstallationID, CatalogID, NodeID, ShortItemNumber),	
	CONSTRAINT SCCatalogNodeItems_SCCatalogNSM_FK FOREIGN KEY(InstallationID,CatalogID,NodeID)
		REFERENCES [dbo].SC_Catalog_NSM(InstallationID,CatalogID,NodeID),
	CONSTRAINT SCCatalogNodeItems_SCItemMaster_FK FOREIGN KEY(InstallationID, ShortItemNumber)
		REFERENCES [dbo].SC_ItemMaster(InstallationID, ShortItemNumber)
)
GO

CREATE TABLE [dbo].SC_CatalogLangs
(
	InstallationID	NVARCHAR(3),
	CatalogID		NVARCHAR(3),
	NodeID			DECIMAL,
	LanguageID		NVARCHAR(2),
	Description		NVARCHAR(30),
	CONSTRAINT SCCatalogLangs_PK PRIMARY KEY(InstallationID, CatalogID, NodeID, LanguageID),
	CONSTRAINT SCCatalogLangs_SCCatalogNSM_FK FOREIGN KEY(InstallationID, CatalogID, NodeID)
		REFERENCES [dbo].SC_Catalog_NSM(InstallationID, CatalogID, NodeID)
)
GO
CREATE TABLE [dbo].SC_ItemMasterLangs
(
	UniqueID		INT IDENTITY(1,1) NOT NULL,
	InstallationID	NVARCHAR(3),
	ShortItemNumber	DECIMAL,
	LanguageID		NVARCHAR(2),
	Description1	NVARCHAR(30),
	Description2	NVARCHAR(30),
	Description3	NVARCHAR(30),
	Content			NVARCHAR(MAX),
	CONSTRAINT SCItemMasterLangs_PK PRIMARY KEY(InstallationID, ShortItemNumber, LanguageID),
	CONSTRAINT SCItemMasterLangs_SCItemMaster_FK FOREIGN KEY(InstallationID, ShortItemNumber) 
		REFERENCES [dbo].SC_ItemMaster(InstallationID, ShortItemNumber)
)
GO
CREATE UNIQUE INDEX SCItemMasterLangs_UniqueID ON [dbo].SC_ItemMasterLangs (UniqueID)
GO

CREATE FULLTEXT CATALOG CatalogNSMSearch;
GO

CREATE FULLTEXT INDEX ON [dbo].SC_ItemMaster(Content, BranchPlant)
KEY INDEX SCItemMaster_UniqueID ON CatalogNSMSearch
WITH CHANGE_TRACKING AUTO;
GO

CREATE FULLTEXT INDEX ON [dbo].SC_ItemMasterLangs(Content)
KEY INDEX SCItemMasterLangs_UniqueID ON CatalogNSMSearch
WITH CHANGE_TRACKING AUTO;

CREATE UNIQUE NONCLUSTERED INDEX SCCatNSMTmp_JobGen_Insta_Cat__Ref_Index on [dbo].SC_Catalog_NSM_TEMP(JobGenerationKey,InstallationID,CatalogID,ReferenceID)

ALTER FULLTEXT INDEX ON [dbo].SC_ItemMaster SET STOPLIST = OFF -- Turn off noise word. ie dash "-"
ALTER FULLTEXT INDEX ON [dbo].SC_ItemMasterLangs SET STOPLIST = OFF -- Turn off noise word. ie dash "-"

GO

CREATE TABLE [dbo].CATALOGMEDIAFILE(
	MediaFileUniqueID bigint NOT NULL,
	MediaFileName NVARCHAR(128) NOT NULL,
	MediaFileType NVARCHAR(2) NOT NULL,
	OriginalFileName NVARCHAR(128) NOT NULL,
	ReSizeConstantPolicy NVARCHAR(30) NOT NULL,
	InstallationOwner NVARCHAR(3) NOT NULL,
	MediaFileComments NVARCHAR(512) NULL,
	MediaFileBody varbinary(max) NULL,
	MediaFileThumbnail varbinary(max) NULL, 
	MediaFileCheckSum INT NULL,
	DateInsert DECIMAL(18, 0) NOT NULL,
	TimeInsert DECIMAL(18, 0) NOT NULL,
	UserInsert NVARCHAR(30) NULL,
	UserUpdate NVARCHAR(30) NULL,
	LastDateUpdated DECIMAL(18, 0) NULL,
	LastTimeUpdated DECIMAL(18, 0) NULL,
	CONSTRAINT PK_CATALOGMEDIAFILE_MediaFileUniqueID PRIMARY KEY CLUSTERED (MediaFileUniqueID ASC)
) 
GO
CREATE NONCLUSTERED INDEX CatalogMediaFile_InstallationOwner ON [dbo].CATALOGMEDIAFILE (InstallationOwner)

GO
CREATE TABLE [dbo].CATALOGSERVERMEDIAFILE(
	InstallationID NVARCHAR(3) NOT NULL,
	ServerName NVARCHAR(128) NOT NULL,
	MediaFileUniqueID bigint NOT NULL,
	MediaFileStatus NVARCHAR(3) NOT NULL,
	LastDateUpdated DECIMAL(18, 0) NULL,
	LastTimeUpdated DECIMAL(18, 0) NULL,
	CONSTRAINT PK_CATALOGSERVERMEDIAFILE PRIMARY KEY CLUSTERED (InstallationID ASC,ServerName ASC,MediaFileUniqueID ASC)
)
GO

CREATE NONCLUSTERED INDEX CatalogServerMediaFile_ServName_MediaFStat ON [dbo].CATALOGSERVERMEDIAFILE (ServerName, MediaFileStatus)
GO
     
CREATE NONCLUSTERED INDEX CatalogServerMediaFile_MediaFileUniqueID ON [dbo].CATALOGSERVERMEDIAFILE (MediaFileUniqueID)
INCLUDE (InstallationID,ServerName,MediaFileStatus)
GO

CREATE TABLE [dbo].CATALOGITEMMEDIAFILE(
	InstallationID NVARCHAR(3) NOT NULL,
	ItemNumber DECIMAL(18, 0) NOT NULL,
	MediaFileUniqueID bigint NOT NULL,
	PriorityIndex int NOT NULL,
	LastDateUpdated DECIMAL(18, 0) NULL,
	LastTimeUpdated DECIMAL(18, 0) NULL,
	DefaultImage int NULL,  
	CONSTRAINT PK_CATALOGITEMMEDIAFILE PRIMARY KEY CLUSTERED (InstallationID ASC,ItemNumber ASC,MediaFileUniqueID ASC)
) 
GO

CREATE NONCLUSTERED INDEX SC_CATALOGITEMMEDIAFILE_MFUniqueID ON [dbo].CATALOGITEMMEDIAFILE ( MediaFileUniqueID ASC ) ON [PRIMARY]

GO

CREATE TABLE [dbo].SC_PrintDocuments(
	RecordUniqueID bigint NOT NULL,
	InstallationID NVARCHAR(3) NOT NULL,
	RegisterID NVARCHAR(30) NULL,
	PrintDocumentType NVARCHAR(20) NOT NULL,
	DocumentID NVARCHAR(256) NOT NULL,
	DocumentBody NVARCHAR(max) NULL,
	UserID DECIMAL(9, 0) NULL,
	WorkStationID NVARCHAR(128) NOT NULL,
	DateUpdated DECIMAL(9, 0) NOT NULL,
	TimeUpdated DECIMAL(9, 0) NOT NULL,
 CONSTRAINT PK_SCPrintDocuments_UniqueId PRIMARY KEY CLUSTERED (RecordUniqueID ASC))
GO
CREATE TABLE [dbo].SC_APIAuthorizations
(
	TokenID				INT IDENTITY(1,1) NOT NULL,
	APIAccessToken		NVARCHAR(512),
	Status				NCHAR(2) NOT NULL,
	Policy				NVARCHAR(1024),
	DateCreated			DECIMAL,
	LastDateUsed		DATETIME2,
	UserID				NVARCHAR(10),
	WorkStationID		NVARCHAR(128), 
	DateUpdated			DECIMAL,
	TimeUpdated			DECIMAL,
	CONSTRAINT SCAPIAuthorizations_PK PRIMARY KEY CLUSTERED (TokenID)
)
GO
CREATE TABLE [dbo].SC_P4210Versions
(
	RecordUniqueID	INT IDENTITY(1,1) NOT NULL,
	InstallationID	NVARCHAR(3) NOT NULL,
	Description		NVARCHAR(60) NOT NULL,
	VersionType		NVARCHAR(1) NOT NULL,
	Sequence		DECIMAL NULL,
	SVersion		NVARCHAR(10) NULL,
	CCVersion		NVARCHAR(10) NULL,
	CONSTRAINT SCP4210Versions_PK PRIMARY KEY (RecordUniqueID)
)
GO

/* Email History */
CREATE TABLE [dbo].SC_EmailHistoryHeader
(
	UniqueID		BIGINT IDENTITY NOT NULL,
	InstallationID	NVARCHAR(3),
	EmailType		INT,
	DocumentID		NVARCHAR(60),
	EmailTo			NVARCHAR(MAX),
	CarbonCopy		NVARCHAR(MAX),
	BlindCarbonCopy NVARCHAR(MAX),
	EmailSubject	NVARCHAR(256),
	EmailPriority	INT,
	ResendDate		DECIMAL(6,0),
	ResendTime		DECIMAL(6,0),
	ResendTo		NVARCHAR(MAX),
	LangPref		NVARCHAR(2),
	UserID			NVARCHAR(10),
	WorkStationID	NVARCHAR(128),
	DateUpdated		DECIMAL(6,0),
	TimeUpdated		DECIMAL(6,0),
	CONSTRAINT PK_SC_EmailHistoryHeader_UniqueID PRIMARY KEY CLUSTERED (UniqueID ASC)
)
GO

CREATE NONCLUSTERED INDEX SC_EmailHistoryHeader_TypeDocumentID ON [dbo].SC_EmailHistoryHeader(InstallationID, EmailType, DocumentID)
INCLUDE (EmailTo, CarbonCopy, EmailPriority, ResendDate, DateUpdated)
GO

CREATE TABLE [dbo].SC_EmailHistoryDetail
(
	UniqueID		BIGINT NOT NULL,
	EmailBody		VARBINARY(MAX),
	UserID			NVARCHAR(10),
	WorkStationID	NVARCHAR(128),
	DateUpdated		DECIMAL(6,0),
	TimeUpdated		DECIMAL(6,0),
	CONSTRAINT PK_SC_EmailHistoryDetail_UniqueID PRIMARY KEY CLUSTERED (UniqueID ASC),
	CONSTRAINT PK_SC_EmailHistoryHeader_UniqueID_FK FOREIGN KEY(UniqueID)
	REFERENCES [dbo].SC_EmailHistoryHeader(UniqueID)
)
GO

/* Migration */
CREATE TABLE [dbo].SC_MigrationSummary
(
	MigrationId		UNIQUEIDENTIFIER NOT NULL,
	MigrationType	INT,
	MigrationMode	INT,
	ContentStatus	INT,
	MigrationStatus	INT,
	ReportUrl		NVARCHAR(MAX),
	ExecutingTrace	NVARCHAR(MAX),
	StartDateTime	DATETIME2(7) NULL,
	DateUpdated		DATETIME2(7) NULL
	CONSTRAINT PK_SC_MigrationSummary_MigrationId PRIMARY KEY CLUSTERED (MigrationId ASC)
)
GO

/* Migration Detail */
CREATE TABLE [dbo].SC_MigrationDetail
(
	UniqueId		INT IDENTITY NOT NULL,
	MigrationId		UNIQUEIDENTIFIER NOT NULL,
	StoreId			NVARCHAR(3),
	EntityType		INT,
	MessageCode		INT,
	Response		NVARCHAR(MAX),
	DateUpdated		DATETIME2(7) NULL
	CONSTRAINT PK_SC_MigrationDetail_UniqueId PRIMARY KEY CLUSTERED (UniqueId ASC)
)
GO

CREATE NONCLUSTERED INDEX SC_MigrationDetail_MigrationId_StoreId ON [dbo].SC_MigrationDetail(MigrationId, StoreId) INCLUDE (EntityType, MessageCode, Response)
GO


